package system

import (
	"github.com/milk9111/sidescroller/ecs"
	"github.com/milk9111/sidescroller/ecs/component"
)

// InvulnerabilitySystem decrements timed invulnerability frames and removes
// the component when the timer expires.
type InvulnerabilitySystem struct{}

func NewInvulnerabilitySystem() *InvulnerabilitySystem { return &InvulnerabilitySystem{} }

func (s *InvulnerabilitySystem) Update(w *ecs.World) {
	if w == nil {
		return
	}
	ecs.ForEach(w, component.InvulnerableComponent.Kind(), func(e ecs.Entity, inv *component.Invulnerable) {
		if inv == nil {
			return
		}
		// Frames == 0 means indefinite; only count down if positive.
		if inv.Frames > 0 {
			inv.Frames--
			if inv.Frames <= 0 {
				_ = ecs.Remove(w, e, component.InvulnerableComponent.Kind())
				return
			}
			_ = ecs.Add(w, e, component.InvulnerableComponent.Kind(), inv)
		}
	})
}
